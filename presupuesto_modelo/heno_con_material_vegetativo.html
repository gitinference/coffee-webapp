<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N칩mina Semanal - Agricultores</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
        }

        th {
            background-color: #f2f2f2;
        }

        input,
        select {
            width: 90%;
        }

        td:first-child,
        th:first-child {
            text-align: left;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"] {
            -moz-appearance: textfield;
            appearance: textfield;
        }
    </style>
    <!-- Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <!-- PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

</head>

<body>
    <div id="botones-acciones" style="text-align: center; margin-top: 40px;">
        <button id="btn-excel">游닌 Descargar Excel</button>
        <button id="btn-pdf">游늯 Guardar PDF</button>
        <button id="btn-email">九괦잺 Enviar por Email</button>
        <button onclick="window.print()">游둳 Imprimir</button>
    </div>
    <h1>Presupuesto modelo: Producci칩n de Pacas de Heno (35 libras) con Pastos Mejorados utilizando MATERIAL VEGETATIVO
        (1 cuerda) (Primer y Segundo a침o)</h1>

    <table>
        <thead>
            <tr>
                <th colspan="9">N칰mero de cuerdas</th>
                <td colspan="1"><input type="number" title="N칰mero de cuerdas sembradas" class="numero_cuerdas" /></td>
            </tr>
            <tr>
                <td colspan="10" style="height: 20px; background-color: transparent;"></td>
            </tr>
            <tr>
                <th colspan="10" style="text-align: center;">GASTOS DE MAQUINARIA Y EQUIPO</th>
            </tr>
            <tr>
                <th colspan="2">PARTIDA</th>
                <th colspan="1">UNIDAD</th>
                <th colspan="1">CANTIDAD</th>
                <th colspan="2">PRECIO</th>
                <th colspan="2">COSTOS PRIMER A칌O</th>
                <th colspan="2">COSTOS SEGUNDO A칌O</th>
            </tr>


        </thead>
        <tbody id="tabla">
            <!-- Filas generadas por JS -->
        </tbody>

        <tfoot>
            <tr>
                <td colspan="10" style="padding: 20px; background-color: #fff; line-height: 1.6;">
                    <h2 style="color: #000000; font-size: 1em">Supuestos</h2>
                    <ol style="padding-left: 20px;">
                        <li>Este estimado de gastos se basa en el uso de material vegetativo.</li>
                        <li>El presupuesto presentado es para el establecimiento y manejo de pastos para los primeros dos a침os.</li>
                        <li>El precio de la maquinaria incluye el operador y el combustible.</li>
                        <li>츼rea con relieve moderado requiere desmonte de 치rboles, arbustos y yerbas.</li>
                        <li>Un pase de arado con un tractor 105-115 HP.</li>
                        <li>Dos pases de rastrillo con un tractor 80-90 HP.</li>
                        <li>El corte de semilla se hace con maquinaria. Se requiere de 1.0 a 1.5 toneladas de estolones maduros por cuerda.</li>
                        <li>El agricultor posee la maquinaria para la aplicaci칩n de abono y de cal.</li>
                        <li>El agricultor posee la maquinaria para corte y alineamiento. El primer corte se realiza despu칠s de 5 meses de la siembra y luego se realizan cortes cada 60 d칤as aproximadamente.</li>
                        <li>Este costo incluye el manejo de la semilla desde donde se corta hasta donde se va a sembrar.</li>
                        <li>La aplicaci칩n de abono se hace principalmente con el uso de maquinaria.</li>
                        <li>La aplicaci칩n de herbicida se hace principalmente con el uso de maquinaria.</li>
                        <li>La finca posee infraestructura para riego.</li>
                        <li>Incluye pago del Seguro Social al Internal Revenue Service, Seguro por Desempleo al Departamento del Trabajo y Recursos Humanos y Seguro Obrero a la Corporaci칩n del Fondo del Seguro del Estado.</li>
                        <li>La cantidad de cal a utilizar depender치 del an치lisis de suelo.</li>
                        <li>Se deben incorporar 100# de superfosfato triple en las primeras 6-8 pulgadas de suelo durante la preparaci칩n del terreno. Esto se puede hacer en uno de los pases de rastrillo.</li>
                        <li>La formulaci칩n y cantidad de fertilizantes va a depender del an치lisis de suelo. Para fines de este estimado de costos se utilizar치 la formulaci칩n 15-5-10 a raz칩n de 3 qq por cuerda al mes de sembrar y 5 qq posterior a cada corte.</li>
                        <li>Incluye herbicidas para el control de malezas de hoja ancha, suculentas y le침osas y el uso de herbicidas no selectivos. El costo incluye surfactante.</li>
                        <li>Se recomienda realizar un an치lisis de suelo para determinar el pH. La acidez del suelo (pH) recomendada para el cultivo de pastos debe ser de 5.5 a 7.0.</li>
                        <li>La finca posee sistema de riego.</li>
                        <li>La producci칩n se estim칩 a raz칩n de 100 pacas por cuerda y cuatro cortes el primer a침o y 5 el segundo a침o. Esta producci칩n puede variar por el manejo de los pastos, las variedades sembradas, factores ambientales y otros.</li>
                        <li>En el segundo a침o no habr치n gastos para el establecimiento de pastos. Esto incluye preparaci칩n del terreno, corte y transporte de semilla y siembra. En el segundo a침o deben aumentar los cortes.</li>
                    </ol>

                    <span style="font-weight: bold;">Preparado y revisado por:</span><br>
                    Myrna Comas Pag치n, PhD<br>
                    Catedr치tica del Servicio de Extensi칩n Agr칤cola en Econom칤a Agr칤cola<br><br>

                    <span style="font-weight: bold;">Versi칩n Electr칩nica:</span><br>
                    Alexandra Gregory Crespo, PhD<br>
                    Catedr치tica del Servicio de Extensi칩n Agr칤cola en Econom칤a Agr칤cola<br><br>

                    Yaira A. Avil칠s Ortiz<br>
                    Economista Agr칤cola<br><br>

                    <span style="font-weight: bold;">Fecha de revisi칩n:</span><br>
                    Marzo 2022<br><br>

                    <div
                        style="margin-top: 20px; padding: 12px; border-left: 5px solid #d9534f; background-color: #fdf2f2;">
                        <strong>AVISO:</strong> Los Presupuestos Modelos presentan la informaci칩n de los ingresos y
                        gastos bajo condiciones normales y caracter칤sticas particulares de una finca. La Universidad de
                        Puerto Rico no asume responsabilidad por los resultados si los ingresos y gastos de una empresa
                        en particular difieren de dicha publicaci칩n. El usuario de estos modelos releva a la Universidad
                        de Puerto Rico de toda responsabilidad, reclamaci칩n, p칠rdida, da침o o costo relacionado o surgido
                        por el uso de estos modelos.
                    </div>

                    <div style="margin-top: 20px; font-size: 0.85em; text-align: center; color: #999;">
                        This material is based upon work supported by USDA/OPPE under Award Number: AO212501x443G010
                    </div>
                </td>
            </tr>
        </tfoot>
    </table>
    <!----------------------------------------------------------------------------------------------------------------------------------------->
    <!----------------------------------------------------------------------------------------------------------------------------------------->
    <!----------------------------------------------------------------------------------------------------------------------------------------->
    <script>
        function formatNumber(value) {
            return new Intl.NumberFormat('es-PR', {
                style: 'decimal',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('es-PR', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            }).format(value);
        }

        const tabla = document.getElementById("tabla");

        document.querySelector(".numero_cuerdas").addEventListener("input", function (e) {
            const numeroCuerdas = parseFloat(e.target.value) || 0;
            // Aqu칤 puedes usar el valor de numeroCuerdas como necesites
            actualizarTotalesGenerales();
        });

        const maquinaria_y_equipo = [
            "Limpieza de area",
            "Arar",
            "Rastrillar",
            "Corte de semilla",
            "Sembrar",
            "Aplicar abono",
            "Aplicar herbicida",
            "Corte y alineaci칩n de pastos",
            "Empaque de heno",
        ];

        maquinaria_y_equipo.forEach((maquinaria, index) => {
            const fila = document.createElement("tr");

            fila.innerHTML = `
                <td colspan='2'>${maquinaria}</td>
                <td colspan='1'>Hora</td>
                <td colspan='1'><input type="number" class="cantidad_maquinaria" data-index="${index}"></td>
                <td colspan='2'><input type="number" class="precio_maquinaria" data-index="${index}"></td>
                <td colspan='2' class="valor_maquinaria" data-index="${index}">$0.00</td>
                <td colspan='2' class="mi_finca_maquinaria" data-index="${index}">${index >= 5 ? formatCurrency(0) : '-'}</td>
                `;

            tabla.appendChild(fila);
        });

        const filaTotal_B = document.createElement("tr");
        filaTotal_B.innerHTML = `
            <th colspan="6">TOTAL DE GASTOS DE MAQUIINARIA</th>
            <th style="background-color: #f0f0f0;" colspan='2' id="valor_maquinaria_total"></th>
            <th style="background-color: #f0f0f0;" colspan='2' class="mi_finca_maquinaria_total"></th>
            `;
        tabla.appendChild(filaTotal_B);

        // Totalizador
        function actualizarTotalesMaquinaria() {
            let totalValor = 0;
            let totalMiFinca = 0;

            document.querySelectorAll(".valor_maquinaria").forEach(cell => {
                const valor = parseFloat(cell.textContent.replace(/[$,]/g, '')) || 0;
                totalValor += valor;
            });

            document.querySelectorAll(".mi_finca_maquinaria").forEach(cell => {
                const index = cell.dataset.index;
                if (index >= 5) {
                    const miFincaValor = parseFloat(cell.textContent.replace(/[$,]/g, '')) || 0;
                    totalMiFinca += miFincaValor;
                }
            });

            const valorCell = document.getElementById("valor_maquinaria_total");
            valorCell.textContent = totalValor == 0 ? '' : formatCurrency(totalValor);

            const miFincaCell = document.querySelector('.mi_finca_maquinaria_total');
            miFincaCell.textContent = totalMiFinca == 0 ? '' : formatCurrency(totalMiFinca);

            return totalValor;
        }

        let maquinaria_y_equipo_total = actualizarTotalesMaquinaria();

        // input listener
        tabla.addEventListener("input", (e) => {
            if (!e.target.matches(".cantidad_maquinaria, .precio_maquinaria")) return;

            const index = e.target.dataset.index;

            const cantidadInput = document.querySelector(`.cantidad_maquinaria[data-index='${index}']`);
            const precioInput = document.querySelector(`.precio_maquinaria[data-index='${index}']`);
            const valorCell = document.querySelector(`.valor_maquinaria[data-index='${index}']`);
            const miFincaCell = document.querySelector(`.mi_finca_maquinaria[data-index='${index}']`);

            const cantidad = parseFloat(cantidadInput.value) || 0;
            const precio = parseFloat(precioInput.value) || 0;
            const total = cantidad * precio;

            valorCell.textContent = formatCurrency(total);
            miFincaCell.textContent = index >= 5 ? formatCurrency(total) : '-';

            maquinaria_y_equipo_total = actualizarTotalesMaquinaria();
        });

        const filaVac칤a_2 = document.createElement("tr");
        filaVac칤a_2.innerHTML = `<td colspan="10" style="height: 20px; background-color: transparent;"></td>`;
        tabla.appendChild(filaVac칤a_2);

        //-----------------------------------------------------------------------------------------------------------------------------------------------------
        //-----------------------------------------------------------------------------------------------------------------------------------------------------
        //-----------------------------------------------------------------------------------------------------------------------------------------------------

        const header1 = document.createElement("tr");
        header1.innerHTML = `<th colspan="10" style="text-align: center;">GASTOS DE MANO DE OBRA</th>`;
        tabla.appendChild(header1);

        const columnas_1 = document.createElement("tr");
        columnas_1.innerHTML = `
            <th colspan="2">PARTIDA</th>
            <th colspan="1">UNIDAD</th>
            <th colspan="1">CANTIDAD</th>
            <th colspan="2">PRECIO</th>
            <th colspan="2">COSTOS PRIMER A칌O</th>
            <th colspan="2">COSTOS SEGUNDO A칌O</th>
            `;
        tabla.appendChild(columnas_1);

        const mano_de_obra_1 = [
            "Corte de semilla y trasnporte",
            "Sembrar",
            "Aplicar cal",
            "Aplicar abono",
            "Aplicar herbicida",
            "Manejo del sistema de riego",
            "Recogido de pacas",
            "Subtotal",
            "Obligaciones patronales",
        ];

        // Generar filas
        mano_de_obra_1.forEach((trabajo, index) => {
            const fila = document.createElement("tr");
            // const numeroCuerdas = parseFloat(document.querySelector(".numero_cuerdas")?.value) || 0;
            fila.innerHTML = `
        <td colspan='2'>${trabajo}</td>
        <td colspan='1'>${index === 6 ? 'Paca' :
                    (index === 7 || index === 8) ? '' :
                        'Hora'
                }</td>
        <td colspan='1'>${(index !== 7 && index !== 8) ? `<input type="number" class="cantidad_mano_de_obra" data-index="${index}">` : ''
                }</td>
        <td colspan='2'>${(index === 7 || index === 8) ? '' : `<input type="number" class="precio_mano_de_obra" data-index="${index}">`}</td>
        <td colspan='2' class="valor_mano_de_obra" data-index="${index}">${trabajo == mano_de_obra_1[12] ? formatCurrency(130) : formatCurrency(0)}</td>
        <td colspan='2' class='mi_finca_mano_de_obra' data-index="${index}">${(index === 0 || index === 1 || index === 2) ? '-' : formatCurrency(0)}</td>
    `;
            tabla.appendChild(fila);
        });

        // Fila total
        const filaTotal_A = document.createElement("tr");
        filaTotal_A.innerHTML = `
        <th colspan="6">TOTAL DE MANO DE OBRA</th>
        <th style="background-color: #f0f0f0;" colspan='2' id="valor_mano_de_obra_total"></th>
        <th style="background-color: #f0f0f0;" colspan='2' class='mi_finca_mano_de_obra_total'></th>
        `;
        tabla.appendChild(filaTotal_A);

        // Totalizador
        function actualizarTotalesManoDeObra() {
            let totalValor = 0;
            let totalMiFinca = 0;

            // Sum only rows that are not subtotal (index 7) or obligaciones patronales (index 8)
            document.querySelectorAll(".valor_mano_de_obra").forEach(cell => {
                const index = cell.dataset.index;
                if (index !== "7" && index !== "8") {
                    const valor = parseFloat(cell.textContent.replace(/[$,]/g, '')) || 0;
                    totalValor += valor;
                }
            });

            document.querySelectorAll(".mi_finca_mano_de_obra").forEach(cell => {
                const index = cell.dataset.index;
                if (index !== "7" && index !== "8") {
                    const miFincaValor = parseFloat(cell.textContent.replace(/[$,]/g, '')) || 0;
                    totalMiFinca += miFincaValor;
                }
            });

            const subtotalCell = document.querySelector(".valor_mano_de_obra[data-index='7']");
            const obligacionesPatronalesCell = document.querySelector(".valor_mano_de_obra[data-index='8']");

            const subtotalMiFincaCell = document.querySelector(".mi_finca_mano_de_obra[data-index='7']");
            const obligacionesPatronalesMiFincaCell = document.querySelector(".mi_finca_mano_de_obra[data-index='8']");

            // subtotal is totalValor
            if (subtotalCell) {
                subtotalCell.textContent = formatCurrency(totalValor);
            }

            // obligaciones patronales is 25% of subtotal
            if (obligacionesPatronalesCell) {
                const subtotal = totalValor;
                const obligaciones = subtotal * 0.20;
                obligacionesPatronalesCell.textContent = formatCurrency(obligaciones);
                totalValor += obligaciones;
            }

            if (subtotalMiFincaCell) {
                subtotalMiFincaCell.textContent = formatCurrency(totalMiFinca);
            }

            if (obligacionesPatronalesMiFincaCell) {
                const subtotalMiFinca = totalMiFinca;
                const obligacionesMiFinca = subtotalMiFinca * 0.20;
                obligacionesPatronalesMiFincaCell.textContent = formatCurrency(obligacionesMiFinca);
                totalMiFinca += obligacionesMiFinca;
            }

            const valorCell = document.getElementById("valor_mano_de_obra_total");
            valorCell.textContent = totalValor ? formatCurrency(totalValor) : '';

            const miFincaCell = document.querySelector('.mi_finca_mano_de_obra_total');
            miFincaCell.textContent = totalMiFinca ? formatCurrency(totalMiFinca) : '';

            return totalValor;
        }

        let mano_de_obra_total = actualizarTotalesManoDeObra();

        // input listener
        tabla.addEventListener("input", (e) => {
            if (!e.target.matches(".cantidad_mano_de_obra, .precio_mano_de_obra")) return;

            const index = e.target.dataset.index;

            const cantidadInput = document.querySelector(`.cantidad_mano_de_obra[data-index='${index}']`);
            const precioInput = document.querySelector(`.precio_mano_de_obra[data-index='${index}']`);
            const valorCell = document.querySelector(`.valor_mano_de_obra[data-index='${index}']`);
            const miFincaCell = document.querySelector(`.mi_finca_mano_de_obra[data-index='${index}']`);

            const cantidad = parseFloat(cantidadInput.value) || 0;
            const precio = parseFloat(precioInput.value) || 0;
            const total = cantidad * precio;

            valorCell.textContent = formatCurrency(total);
            miFincaCell.textContent = index === "0" || index === "1" || index === "2" ? '-' : formatCurrency(total);

            mano_de_obra_total = actualizarTotalesManoDeObra();
        });


        const filaVac칤a_1 = document.createElement("tr");
        filaVac칤a_1.innerHTML = `<td colspan="10" style="height: 20px; background-color: transparent;"></td>`;
        tabla.appendChild(filaVac칤a_1);

        //-----------------------------------------------------------------------------------------------------------------------------------------------------  
        //-----------------------------------------------------------------------------------------------------------------------------------------------------
        //-----------------------------------------------------------------------------------------------------------------------------------------------------

        const header2 = document.createElement("tr");
        header2.innerHTML = `<th colspan="10" style="text-align: center;">GASTOS EN MATERIALES</th>`;
        tabla.appendChild(header2);

        columnas_2 = document.createElement("tr");
        columnas_2.innerHTML = `
        <th colspan="2">PARTIDA</th>
        <th colspan="1">UNIDAD</th>
      <th colspan="1">CANTIDAD</th>
      <th colspan="2">PRECIO</th>
      <th colspan="2">COSTOS PRIMER A칌O</th>
      <th colspan="2">COSTOS SEGUNDO A칌O</th>
    `;
        tabla.appendChild(columnas_2);


        const materiales = [
            ["Cal", "ton"],
            ["Superfosfato triple", "saco"],
            ["Fertilizante", "qq"],
            ["Herbicidas", "-"],
            ["Combustible", "gal칩n"],
            ["Hilo", "rollo"]
        ];

        materiales.forEach((material, index) => {
            const fila = document.createElement("tr");

            // Para la columna "COSTOS SEGUNDO A칌O" (mi_finca_material):
            // Si index 0 o 1, mostrar '-', el resto $0.00 (y cambiar치 con input)
            let miFincaSegundoAno = (index === 0 || index === 1) ? '-' : (index === 3 ? formatCurrency(28) : formatCurrency(0));

            fila.innerHTML = `
        <td colspan='2'>${material[0]}</td>
        <td colspan='1'>${material[1]}</td>
        <td colspan='1'>${index !== 3 ? `<input type="number" class="cantidad_material" data-index="${index}">` : `-`}</td>
        <td colspan='2'>${index !== 3 ? `<input type="number" class="precio_material" data-index="${index}">` : `-`}</td>
        <td colspan='2' class="valor_material" data-index="${index}">${index !== 3 ? formatCurrency(0) : formatCurrency(28)}</td>
        <td colspan='2' class="mi_finca_material" data-index="${index}">${miFincaSegundoAno}</td>
          `;

            tabla.appendChild(fila);
        });

        const filaTotal_C = document.createElement("tr");
        filaTotal_C.innerHTML = `
        <th colspan="6">TOTAL DE GASTO EN MATERIALES</th>
        <th style="background-color: #f0f0f0;" colspan='2' id="valor_material_total"></th>
        <th style="background-color: #f0f0f0;" colspan='2' class="mi_finca_material_total"></th>
          `;
        tabla.appendChild(filaTotal_C);

        // Totalizador
        function actualizarTotalesMaterial() {
            let totalValor = 0;
            let totalMiFinca = 0;

            document.querySelectorAll(".valor_material").forEach(cell => {
                const valor = parseFloat(cell.textContent.replace(/[$,]/g, '')) || 0;
                totalValor += valor;
            });

            document.querySelectorAll(".mi_finca_material").forEach(cell => {
                const index = parseInt(cell.dataset.index, 10);
                // Solo sumar si no es el primer ni segundo material (index > 1)
                if (index > 1) {
                    const valor = parseFloat(cell.textContent.replace(/[$,]/g, '')) || 0;
                    totalMiFinca += valor;
                }
            });

            const valorCell = document.getElementById("valor_material_total");
            const miFincaCell = document.querySelector('.mi_finca_material_total');

            valorCell.textContent = totalValor == 0 ? '' : formatCurrency(totalValor);
            miFincaCell.textContent = totalMiFinca ? formatCurrency(totalMiFinca) : '';

            return totalValor;
        }

        let materiales_total = actualizarTotalesMaterial();

        // input listener
        tabla.addEventListener("input", (e) => {
            if (!e.target.matches(".cantidad_material, .precio_material")) return;

            const index = parseInt(e.target.dataset.index, 10);

            const cantidadInput = document.querySelector(`.cantidad_material[data-index='${index}']`);
            const precioInput = document.querySelector(`.precio_material[data-index='${index}']`);
            const valorCell = document.querySelector(`.valor_material[data-index='${index}']`);
            const miFincaCell = document.querySelector(`.mi_finca_material[data-index='${index}']`);

            const cantidad = parseFloat(cantidadInput?.value) || 0;
            const precio = parseFloat(precioInput?.value) || 0;
            const total = cantidad * precio;

            valorCell.textContent = formatCurrency(total);

            // Para index 0 y 1, siempre mostrar '-'
            if (index === 0 || index === 1) {
                miFincaCell.textContent = '-';
            } else {
                miFincaCell.textContent = formatCurrency(total);
            }

            materiales_total = actualizarTotalesMaterial();
        });

        const filaVac칤a_3 = document.createElement("tr");
        filaVac칤a_3.innerHTML = `<td colspan="10" style="height: 20px; background-color: transparent;"></td>`;
        tabla.appendChild(filaVac칤a_3);

        //-----------------------------------------------------------------------------------------------------------------------------------------------------
        //-----------------------------------------------------------------------------------------------------------------------------------------------------
        //----------------------------------------------------------------------------------------------------------------------------------------------------- 

        const header3 = document.createElement("tr");
        header3.innerHTML = `<th colspan="10" style="text-align: center;">OTROS GASTOS</th>`;
        tabla.appendChild(header3);

        columnas_3 = document.createElement("tr");
        columnas_3.innerHTML = `
      <th colspan="6">PARTIDA</th>
      <th colspan="2">COSTOS PRIMER A칌O</th>
      <th colspan="2">COSTOS SEGUNDO A칌O</th>
    `;
        tabla.appendChild(columnas_3);

        const otros_gastos = [
            ["An치lisis de suelo", "$20.00"],
            ["Renta de terreno", "$100.00"],
            ["Gastos Miscel치neos", "$50.00"]
        ];

        otros_gastos.forEach((gasto, index) => {
            const fila = document.createElement("tr");

            fila.innerHTML = `
        <td colspan='6'>${gasto[0]}</td>
        <td colspan='2'>${gasto[1]}</td>
        <td colspan='2' class="mi_finca_otros_gastos" data-index="${index}">${index === 0 ? '-' : gasto[1]}</td>
      `;

            tabla.appendChild(fila);
        });

        const filaTotal_D = document.createElement("tr");
        filaTotal_D.innerHTML = `
            <th colspan="6">TOTAL DE OTROS GASTOS</th>
            <th style="background-color: #f0f0f0;" colspan='2' id="total_otros_gastos"></th>
            <th style="background-color: #f0f0f0;" colspan='2' id="mi_finca_otros_gastos_total"></th>
        `;
        tabla.appendChild(filaTotal_D);

        // Totalizador
        function actualizarTotalesOtrosGastos() {
            const totalOtrosGastos = document.getElementById("total_otros_gastos");
            totalOtrosGastos.textContent = formatCurrency(170);

            const totalMiFincaElement = document.getElementById("mi_finca_otros_gastos_total");
            totalMiFincaElement.textContent = formatCurrency(150);

            return 170; // Valor fijo de otros gastos
        }

        let otros_gastos_total = actualizarTotalesOtrosGastos();

        // input listener
        tabla.addEventListener("input", (e) => {
            if (!e.target.matches(".valor_otros_gastos")) return;
            const index = e.target.dataset.index;
            const miFincaCell = document.querySelector(`.mi_finca_otros_gastos[data-index='${index}']`);
            const valor = parseFloat(e.target.value) || 0;
            const numeroCuerdas = parseFloat(document.querySelector(".numero_cuerdas")?.value) || 0;
            miFincaCell.textContent = formatCurrency(valor * numeroCuerdas);
            otros_gastos_total = actualizarTotalesOtrosGastos();
        });

        const total_gastos = document.createElement("tr");
        total_gastos.innerHTML = `
        <th colspan="6">TOTAL DE GASTOS</th>
        <th style="background-color: #f0f0f0;" colspan='2' id="gastos_total"></th>
        <th style="background-color: #f0f0f0;" colspan='2' id="mi_finca_gastos_total"></th>
      `;
        tabla.appendChild(total_gastos);

        // Totalizador
        function actualizarTotalGastos() {
            const totalGastos = mano_de_obra_total + maquinaria_y_equipo_total + materiales_total + otros_gastos_total;
            document.getElementById("gastos_total").textContent = formatCurrency(totalGastos);
            document.getElementById("mi_finca_gastos_total").textContent = formatCurrency(totalGastos);

            return totalGastos;
        }

        let gastos_totales = actualizarTotalGastos();

        // input listener
        tabla.addEventListener("input", (e) => {
            if (!e.target.matches(".cantidad_mano_de_obra, .precio_mano_de_obra, .cantidad_maquinaria, .precio_maquinaria, .cantidad_material, .precio_material, .valor_otros_gastos")) return;

            gastos_totales = actualizarTotalGastos();
        });

        const filaVac칤a_4 = document.createElement("tr");
        filaVac칤a_4.innerHTML = `<td colspan="10" style="height: 20px; background-color: transparent;"></td>`;
        tabla.appendChild(filaVac칤a_4);

        //-----------------------------------------------------------------------------------------------------------------------------------------------------
        //-----------------------------------------------------------------------------------------------------------------------------------------------------
        //----------------------------------------------------------------------------------------------------------------------------------------------------- 

        const header4 = document.createElement("tr");
        header4.innerHTML = `<th colspan="10" style="text-align: center;">INGRESOS ESPERADOS</th>`;
        tabla.appendChild(header4);

        columnas_4 = document.createElement("tr");
        columnas_4.innerHTML = `
      <th colspan="2">PARTIDA</th>
      <th colspan="1">UNIDAD</th>
      <th colspan="1">CANTIDAD</th>
      <th colspan="2">PRECIO</th>
      <th colspan="2">COSTOS PRIMER A칌O</th>
      <th colspan="2">COSTOS SEGUNDO A칌O</th>
    `;
        tabla.appendChild(columnas_4);

        const ingresos = [
            "Venta de heno",
            "Subsidio salarial"
        ];

        ingresos.forEach((ingreso, index) => {
            const fila = document.createElement("tr");

            const isSubsidio = ingreso === "Subsidio salarial";
            const cantidad = isSubsidio ? '' : 400;
            const precio = isSubsidio
                    ? `<input type="number" id="subsidio_salarial" />`
                    : `<input type="number" id="precio_ingreso" />`

            fila.innerHTML = `
            <td colspan='2'>${ingreso}</td>
            <td colspan='1'>${isSubsidio ? '' : 'Pacas'}</td>
            <td colspan='1'>${cantidad}</td>
            <td colspan='2'>${precio}</td>
            <td colspan='2' class='valor_ingreso' data-index="${index}">${formatCurrency(0)}</td>
            <td colspan='2' class='mi_finca_ingreso' data-index="${index}">${formatCurrency(0)}</td>
        `;

            tabla.appendChild(fila);
        });

        // fila total ingresos
        const filaTotal_F = document.createElement("tr");
        filaTotal_F.innerHTML = `
        <th colspan="6">TOTAL DE INGRESOS</th>
        <th style="background-color: #f0f0f0;" colspan='2' class='valor_ingreso_total'></th>
        <th style="background-color: #f0f0f0;" colspan='2' class='mi_finca_total'>$ -</th>
        `;
        tabla.appendChild(filaTotal_F);

        // totalizador
        function actualizarTotalesIngresos() {
            let total = 0;
            document.querySelectorAll('.valor_ingreso').forEach(cell => {
                total += parseFloat(cell.textContent.replace(/[$,]/g, '')) || 0;
            });

            document.querySelector('.valor_ingreso_total').textContent = formatCurrency(total);
            document.querySelector('.mi_finca_total').textContent = formatCurrency(total);

            return total;
        }

        let ingresos_totales = actualizarTotalesIngresos();

        // input listener
        tabla.addEventListener("input", (e) => {
            if (e.target.id !== "precio_ingreso" && e.target.id !== "subsidio_salarial") return;

            let valor = 0;

            if (e.target.id === "precio_ingreso") {
            // Venta de heno: cantidad * precio
            const cantidad = 400; // hardcoded as per table
            const precio = parseFloat(document.getElementById("precio_ingreso")?.value) || 0;
            valor = cantidad * precio;
            const valorCell = document.querySelector(`.valor_ingreso[data-index="0"]`);
            if (valorCell) valorCell.textContent = formatCurrency(valor);
            const miFincaIngresoCell = document.querySelector(`.mi_finca_ingreso[data-index="0"]`);
            if (miFincaIngresoCell) miFincaIngresoCell.textContent = formatCurrency(valor);
            } else if (e.target.id === "subsidio_salarial") {
            // Subsidio salarial: input value
            valor = parseFloat(document.getElementById("subsidio_salarial")?.value) || 0;
            const valorCell = document.querySelector(`.valor_ingreso[data-index="1"]`);
            if (valorCell) valorCell.textContent = formatCurrency(valor);
            const miFincaIngresoCell = document.querySelector(`.mi_finca_ingreso[data-index="1"]`);
            if (miFincaIngresoCell) miFincaIngresoCell.textContent = formatCurrency(valor);
            }

            // Actualizar totales
            ingresos_totales = actualizarTotalesIngresos();
        });

        const ingreso_neto = document.createElement("tr");
        ingreso_neto.innerHTML = `
            <th colspan="6">INGRESO NETO</th>
            <th style="background-color: #f0f0f0;" colspan='2' id='ingreso_neto_total'></th>
            <th style="background-color: #f0f0f0;" colspan='2' class='mi_finca_ingreso_neto_total'>$ -</th>
        `;
        tabla.appendChild(ingreso_neto);

        // Totalizador
        function actualizarIngresoNeto() {
            const ingresoNeto = ingresos_totales - gastos_totales;
            document.getElementById("ingreso_neto_total").textContent = formatCurrency(ingresoNeto);
            document.querySelector('.mi_finca_ingreso_neto_total').textContent = formatCurrency(ingresoNeto);
            return ingresoNeto;
        }

        let ingreso_neto_total = actualizarIngresoNeto();

        // input listener
        tabla.addEventListener("input", (e) => {
            // Actualizar ingreso_neto siempre que cualquier input relevante cambie
            ingreso_neto_total = actualizarIngresoNeto();
            actualizarTotalesGenerales(); // <-- A칌ADIDO: actualiza los totales generales en cada cambio
        });

        const filaVac칤a_7 = document.createElement("tr");
        filaVac칤a_7.innerHTML = `<td colspan="10" style="height: 20px; background-color: transparent;"></td>`;
        tabla.appendChild(filaVac칤a_7);

        //-----------------------------------------------------------------------------------------------------------------------------------------------------
        //-----------------------------------------------------------------------------------------------------------------------------------------------------
        //-----------------------------------------------------------------------------------------------------------------------------------------------------

        columnas_5 = document.createElement("tr");
        columnas_5.innerHTML = `
          <th colspan="6">PARTIDA</th>
          <th colspan="1">PRIMER A칌O VALOR</th>
          <th colspan="1">PRIMER A칌O MI FINCA</th>
          <th colspan="1">SEGUNDO A칌O VALOR</th>
          <th colspan="1">SEGUNDO A칌O MI FINCA</th>
        `;
        tabla.appendChild(columnas_5);

        totales = [
            'Ingreso Total',
            'Gasto Total',
            'Ingreso Neto',
            'Producci칩n M칤nima (pacas 35 lbs)'
        ];

        totales.forEach((total, index) => {
            const fila = document.createElement("tr");

            fila.innerHTML = `
        <td colspan='6'>${total}</td>
        <!-- Estandar -->
        <td colspan='1'><span id="primer_valor_${index}">-</span></td>
        <td colspan='1'><span class='primer_valor_mi_finca_${index}'>-</span></td>
        <td colspan='1'><span id="segundo_valor_${index}">-</span></td>
        <td colspan='1'><span class='segundo_valor_mi_finca_${index}'>-</span></td>
          `;

            tabla.appendChild(fila);
        });

        function formatSignedCurrency(value) {
            const abs = Math.abs(value);
            const formatted = formatCurrency(abs).replace('$', ''); // remove $ from inside
            return value < 0 ? `$(${formatted})` : `$${formatted}`;
        }

        // Totalizador
        function actualizarTotalesGenerales() {
            const numeroCuerdas = parseFloat(document.querySelector(".numero_cuerdas")?.value) || 0;

            // Primer a침o
            const ingresoTotalPrimerAno = ingresos_totales;
            const gastoTotalPrimerAno = gastos_totales;
            const ingresoNetoPrimerAno = ingresoTotalPrimerAno - gastoTotalPrimerAno;

            // Segundo a침o (puedes ajustar la l칩gica seg칰n corresponda)
            const ingresoTotalSegundoAno = ingresos_totales; // Cambia si tienes l칩gica diferente
            const gastoTotalSegundoAno = gastos_totales;     // Cambia si tienes l칩gica diferente
            const ingresoNetoSegundoAno = ingresoTotalSegundoAno - gastoTotalSegundoAno;

            // Ingreso Total (no solicitado, pero puedes agregar si lo necesitas)
            document.getElementById("primer_valor_0").textContent = formatSignedCurrency(ingresoTotalPrimerAno);
            document.querySelector('.primer_valor_mi_finca_0').textContent = formatSignedCurrency(ingresoTotalPrimerAno * numeroCuerdas);
            document.getElementById("segundo_valor_0").textContent = formatSignedCurrency(ingresoTotalSegundoAno);
            document.querySelector('.segundo_valor_mi_finca_0').textContent = formatSignedCurrency(ingresoTotalSegundoAno * numeroCuerdas);

            // Gasto Total
            document.getElementById("primer_valor_1").textContent = formatSignedCurrency(gastoTotalPrimerAno);
            document.querySelector('.primer_valor_mi_finca_1').textContent = formatSignedCurrency(gastoTotalPrimerAno * numeroCuerdas);
            document.getElementById("segundo_valor_1").textContent = formatSignedCurrency(gastoTotalSegundoAno);
            document.querySelector('.segundo_valor_mi_finca_1').textContent = formatSignedCurrency(gastoTotalSegundoAno * numeroCuerdas);

            // Ingreso Neto
            document.getElementById("primer_valor_2").textContent = formatSignedCurrency(ingresoNetoPrimerAno);
            document.querySelector('.primer_valor_mi_finca_2').textContent = formatSignedCurrency(ingresoNetoPrimerAno * numeroCuerdas);
            document.getElementById("segundo_valor_2").textContent = formatSignedCurrency(ingresoNetoSegundoAno);
            document.querySelector('.segundo_valor_mi_finca_2').textContent = formatSignedCurrency(ingresoNetoSegundoAno * numeroCuerdas);

            // Producci칩n M칤nima (pacas 35 lbs)
            // Obtener el precio de venta de heno ingresado por el usuario
            const precioVentaHeno = parseFloat(document.getElementById("precio_ingreso")?.value) || 0;
            let produccionMinimaPrimerAno = 0;
            let produccionMinimaSegundoAno = 0;

            if (precioVentaHeno > 0) {
                produccionMinimaPrimerAno = gastoTotalPrimerAno / precioVentaHeno;
                produccionMinimaSegundoAno = gastoTotalSegundoAno / precioVentaHeno;
            }

            document.getElementById("primer_valor_3").textContent = precioVentaHeno > 0 ? formatNumber(produccionMinimaPrimerAno) : '-';
            document.querySelector('.primer_valor_mi_finca_3').textContent = precioVentaHeno > 0 ? formatNumber(produccionMinimaPrimerAno * numeroCuerdas) : '-';
            document.getElementById("segundo_valor_3").textContent = precioVentaHeno > 0 ? formatNumber(produccionMinimaSegundoAno) : '-';
            document.querySelector('.segundo_valor_mi_finca_3').textContent = precioVentaHeno > 0 ? formatNumber(produccionMinimaSegundoAno * numeroCuerdas) : '-';
        }

        // Inicializar los valores al cargar la p치gina
        actualizarTotalesGenerales();

        // Descargar Excel
        document.getElementById("btn-excel").addEventListener("click", function () {
            const table = document.querySelector("table");
            const wb = XLSX.utils.table_to_book(table, { sheet: "Presupuesto" });
            XLSX.writeFile(wb, "presupuesto.xlsx");
        });

        // Guardar PDF
        document.getElementById("btn-pdf").addEventListener("click", function () {
            const content = document.body;
            html2pdf().from(content).set({
                margin: 0.5,
                filename: "presupuesto.pdf",
                html2canvas: { scale: 2 },
                jsPDF: { unit: "in", format: "letter", orientation: "portrait" }
            }).save();
        });

        // Enviar por Email
        document.getElementById("btn-email").addEventListener("click", function () {
            const asunto = "Presupuesto Modelo";
            const cuerpo = "Saludos,\n\nAdjunto encontrar치 el presupuesto modelo generado.\n\nGracias.";
            window.location.href = `mailto:?subject=${encodeURIComponent(asunto)}&body=${encodeURIComponent(cuerpo)}`;
        });


    </script>
</body>

</html>



<!-- ejemplo, pagina de caf칠, copy, paste y ajustan -->